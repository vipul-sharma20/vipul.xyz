<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Routes Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-geo.v3.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f4ede1;
            color: #2c3e50;
            overflow: hidden;
            min-height: 100vh;
        }

        #map-container {
            width: 100%;
            background: #f4ede1;
            position: relative;
            min-height: 100vh;
        }

        #map-wrapper {
            width: 100%;
            height: 100%;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
            background: #f4ede1;
        }

        html, body, #map-container {
            height: 100%;
            width: 100%;
        }

        svg {
            display: block;
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        svg:active {
            cursor: grabbing;
        }

        .country {
            stroke: #9a8a6e;
            stroke-width: 0.5;
            stroke-linejoin: round;
            stroke-linecap: round;
            vector-effect: non-scaling-stroke;
            transition: filter 0.3s ease;
        }

        .country:hover {
            filter: brightness(0.92);
        }

        .flight-path {
            fill: none;
            stroke-width: 1.2;
            opacity: 0.7;
            vector-effect: non-scaling-stroke;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .flight-path-hitarea {
            fill: none;
            stroke: transparent;
            stroke-width: 12;
            opacity: 0;
            vector-effect: non-scaling-stroke;
            cursor: pointer;
        }

        .flight-path.hover {
            stroke-width: 2.5;
            opacity: 1;
            filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.6));
        }

        .airport {
            fill: #1e40af;
            stroke: none;
            cursor: pointer;
            vector-effect: non-scaling-stroke;
            transition: all 0.3s ease;
        }

        .airport:hover {
            filter: drop-shadow(0 0 6px rgba(231, 76, 60, 1.0));
        }

        .airport-label {
            fill: #2c3e50;
            font-size: 3px;
            font-weight: 700;
            pointer-events: none;
            opacity: 0;
            text-anchor: middle;
            font-family: 'Alegreya Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: opacity 0.2s ease;
            filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8));
        }

        .airport-label.hover {
            opacity: 1;
        }

        /* Legend */
        #legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            z-index: 1000;
        }

        #legend h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }

        .legend-section {
            margin-bottom: 12px;
        }

        .legend-section:last-child {
            margin-bottom: 0;
        }

        .legend-section-title {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-gradient {
            width: 100%;
            height: 12px;
            border-radius: 2px;
            margin-bottom: 4px;
        }

        .legend-gradient-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #6b7280;
        }

        .legend-circle {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #1e40af;
        }

        .legend-text {
            color: #2c3e50;
            font-size: 12px;
        }

        /* Custom tooltip */
        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s ease;
            z-index: 10000;
            white-space: nowrap;
        }

        #tooltip.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            #legend {
                bottom: 10px;
                right: 10px;
                padding: 10px;
                font-size: 11px;
            }

            #legend h3 {
                font-size: 12px;
                margin-bottom: 8px;
            }

            .legend-item {
                margin-bottom: 6px;
            }

            .legend-text {
                font-size: 11px;
            }

            .legend-line {
                width: 25px;
            }

            .legend-circle {
                width: 6px;
                height: 6px;
            }
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map-wrapper">
            <svg id="map"></svg>
            <div id="tooltip"></div>
            <div id="legend">
                <div class="legend-section">
                    <div class="legend-section-title">Flight Frequency</div>
                    <div class="legend-gradient" id="frequency-gradient"></div>
                    <div class="legend-gradient-labels">
                        <span>1 flight</span>
                        <span id="max-flights-label">Max flights</span>
                    </div>
                </div>
                <div class="legend-section">
                    <div class="legend-item">
                        <div class="legend-circle"></div>
                        <span class="legend-text">Airport</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Airport coordinates database
        const airportCoords = {
            'DEL': [77.1025, 28.5562], // Delhi
            'BLR': [77.7064, 13.1986], // Bangalore
            'LKO': [80.8893, 26.7606], // Lucknow
            'PNQ': [73.9197, 18.5822], // Pune
            'HYD': [78.4294, 17.2403], // Hyderabad
            'GOI': [73.8314, 15.3808], // Goa
            'IXZ': [92.7296, 11.6410], // Port Blair
            'IXB': [88.3295, 26.6812], // Bagdogra
            'JLR': [80.0520, 23.1778], // Jabalpur
            'SIN': [103.9894, 1.3644], // Singapore
            'KUL': [101.7099, 2.7456], // Kuala Lumpur
            'BOM': [72.8777, 19.0896], // Mumbai
            'KNU': [80.4100, 26.4041], // Kanpur
            'IXD': [81.7339, 25.4405], // Allahabad
            'BKK': [100.7501, 13.6900], // Bangkok
            'HKT': [98.3169, 8.1132], // Phuket
            'DMK': [100.6074, 13.9126], // Bangkok Don Mueang
            'BHO': [77.3374, 23.2876], // Bhopal
            'AUH': [54.6511, 24.4330], // Abu Dhabi
            'LHR': [-0.4543, 51.4700], // London Heathrow
            'COK': [76.4011, 10.1520], // Cochin
            'MLE': [73.5290, 4.1916], // Male (Maldives)
            'VNS': [82.8594, 25.4520], // Varanasi
            'SGN': [106.6519, 10.8188], // Ho Chi Minh
            'HAN': [105.8019, 21.2212], // Hanoi
            'CCU': [88.4467, 22.6547], // Kolkata
            'DAD': [108.1991, 16.0439]  // Danang
        };

        // City names for airports
        const cityNames = {
            'DEL': 'Delhi',
            'BLR': 'Bangalore',
            'LKO': 'Lucknow',
            'PNQ': 'Pune',
            'HYD': 'Hyderabad',
            'GOI': 'Goa',
            'IXZ': 'Port Blair',
            'IXB': 'Bagdogra',
            'JLR': 'Jabalpur',
            'SIN': 'Singapore',
            'KUL': 'Kuala Lumpur',
            'BOM': 'Mumbai',
            'KNU': 'Kanpur',
            'IXD': 'Allahabad',
            'BKK': 'Bangkok',
            'HKT': 'Phuket',
            'DMK': 'Bangkok',
            'BHO': 'Bhopal',
            'AUH': 'Abu Dhabi',
            'LHR': 'London',
            'COK': 'Cochin',
            'MLE': 'Male',
            'VNS': 'Varanasi',
            'SGN': 'Ho Chi Minh',
            'HAN': 'Hanoi',
            'CCU': 'Kolkata',
            'DAD': 'Danang'
        };

        // Flight data
        const flights = [
            {from: 'IXD', to: 'BLR'},
            {from: 'DEL', to: 'BLR'},
            {from: 'BLR', to: 'DEL'},
            {from: 'DEL', to: 'BLR'},
            {from: 'BLR', to: 'JLR'},
            {from: 'JLR', to: 'BLR'},
            {from: 'BLR', to: 'BOM'},
            {from: 'BLR', to: 'BOM'},
            {from: 'KUL', to: 'BLR'},
            {from: 'KNU', to: 'BLR'},
            {from: 'BOM', to: 'BLR'},
            {from: 'BOM', to: 'BLR'},
            {from: 'BLR', to: 'IXD'},
            {from: 'DEL', to: 'BLR'},
            {from: 'IXZ', to: 'BLR'},
            {from: 'DEL', to: 'BLR'},
            {from: 'BLR', to: 'BOM'},
            {from: 'BKK', to: 'HKT'},
            {from: 'BLR', to: 'KNU'},
            {from: 'BOM', to: 'LHR'},
            {from: 'BLR', to: 'DEL'},
            {from: 'BLR', to: 'DEL'},
            {from: 'BLR', to: 'SIN'},
            {from: 'BOM', to: 'BLR'},
            {from: 'BOM', to: 'BLR'},
            {from: 'COK', to: 'MLE'},
            {from: 'BLR', to: 'DEL'},
            {from: 'BLR', to: 'BOM'},
            {from: 'BLR', to: 'GOI'},
            {from: 'BOM', to: 'BLR'},
            {from: 'SIN', to: 'BLR'},
            {from: 'BLR', to: 'IXZ'},
            {from: 'BLR', to: 'DMK'},
            {from: 'BLR', to: 'BOM'},
            {from: 'DEL', to: 'BLR'},
            {from: 'HKT', to: 'DMK'},
            {from: 'BLR', to: 'COK'},
            {from: 'PNQ', to: 'BLR'},
            {from: 'BLR', to: 'SIN'},
            {from: 'LKO', to: 'BLR'},
            {from: 'BOM', to: 'BLR'},
            {from: 'BLR', to: 'LKO'},
            {from: 'LHR', to: 'BLR'},
            {from: 'DEL', to: 'BLR'},
            {from: 'BLR', to: 'DEL'},
            {from: 'BLR', to: 'DEL'},
            {from: 'DMK', to: 'HKT'},
            {from: 'KUL', to: 'SGN'},
            {from: 'BLR', to: 'BOM'},
            {from: 'BLR', to: 'BKK'},
            {from: 'DEL', to: 'BLR'},
            {from: 'VNS', to: 'DEL'},
            {from: 'BLR', to: 'IXB'},
            {from: 'DEL', to: 'BLR'},
            {from: 'GOI', to: 'BLR'},
            {from: 'BLR', to: 'DEL'},
            {from: 'BLR', to: 'LKO'},
            {from: 'BLR', to: 'BOM'},
            {from: 'BKK', to: 'BLR'},
            {from: 'BLR', to: 'DEL'},
            {from: 'BLR', to: 'DEL'},
            {from: 'BLR', to: 'PNQ'},
            {from: 'BLR', to: 'LKO'},
            {from: 'BOM', to: 'BLR'},
            {from: 'DEL', to: 'BLR'},
            {from: 'DEL', to: 'BLR'},
            {from: 'BLR', to: 'GOI'},
            {from: 'BLR', to: 'HYD'},
            {from: 'DEL', to: 'BLR'},
            {from: 'DEL', to: 'BLR'},
            {from: 'BLR', to: 'DEL'},
            {from: 'BLR', to: 'BHO'},
            {from: 'CCU', to: 'BLR'},
            {from: 'BLR', to: 'AUH'},
            {from: 'BOM', to: 'BLR'},
            {from: 'HYD', to: 'DEL'},
            {from: 'SGN', to: 'DAD'},
            {from: 'HAN', to: 'CCU'},
            {from: 'DEL', to: 'BLR'},
            {from: 'BLR', to: 'BOM'},
            {from: 'DEL', to: 'BLR'},
            {from: 'BLR', to: 'BOM'},
            {from: 'BHO', to: 'BLR'},
            {from: 'BLR', to: 'SIN'},
            {from: 'BLR', to: 'BOM'},
            {from: 'BLR', to: 'LKO'},
            {from: 'GOI', to: 'BLR'},
            {from: 'DEL', to: 'BLR'},
            {from: 'BLR', to: 'DEL'},
            {from: 'DAD', to: 'HAN'},
            {from: 'DEL', to: 'BLR'},
            {from: 'BOM', to: 'BLR'},
            {from: 'IXB', to: 'DEL'},
            {from: 'AUH', to: 'BLR'},
            {from: 'BLR', to: 'DEL'},
            {from: 'SIN', to: 'BLR'},
            {from: 'DEL', to: 'BLR'},
            {from: 'LKO', to: 'BLR'},
            {from: 'DEL', to: 'BLR'},
            {from: 'BLR', to: 'BOM'},
            {from: 'DEL', to: 'BLR'},
            {from: 'BLR', to: 'DEL'},
            {from: 'MLE', to: 'BLR'},
            {from: 'BLR', to: 'KUL'},
            {from: 'DEL', to: 'BLR'},
            {from: 'BLR', to: 'DEL'},
            {from: 'BOM', to: 'BLR'},
            {from: 'DEL', to: 'BLR'},
            {from: 'DMK', to: 'BLR'},
            {from: 'BLR', to: 'DEL'},
            {from: 'HKT', to: 'DMK'},
            {from: 'LKO', to: 'BLR'},
            {from: 'BLR', to: 'LKO'},
            {from: 'BLR', to: 'DEL'}
        ];

        // Setup
        const container = document.getElementById('map-wrapper');
        const width = container.clientWidth;
        const height = container.clientHeight;

        // Create SVG
        const svg = d3.select('#map')
            .attr('viewBox', `0 0 ${width} ${height}`)
            .attr('preserveAspectRatio', 'xMidYMid meet');

        const g = svg.append('g');

        // Initial projection centered on India
        const projection = d3.geoMercator()
            .center([78, 20])
            .scale(450)
            .translate([width / 2, height / 2]);

        const path = d3.geoPath().projection(projection);

        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.5, 8])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // Define vintage/retro map color palette
        const vintageMapColors = [
            '#e6a67e', '#d4926e', '#c4a47e', '#e8d39a', '#f0d89a', '#d4c48a',
            '#b8c8a0', '#99b088', '#a8b898', '#b8a8b8', '#a898a8', '#c8b8c8',
            '#a8c8d8', '#8ab8c8', '#b8d8c8', '#e8c89a', '#d4b88a', '#c8a878',
            '#d8b898', '#c8b8a8', '#b8a898', '#d8c8a8', '#a8b8a8', '#98a898',
            '#e8b88a', '#d8a87a', '#c8987a', '#b8c898', '#a8b888', '#98a878'
        ];

        // Function to get random vintage map color
        function getRandomVintageColor() {
            return vintageMapColors[Math.floor(Math.random() * vintageMapColors.length)];
        }

        // Count route frequencies
        const routeFrequencies = new Map();
        flights.forEach(flight => {
            const key = `${flight.from}-${flight.to}`;
            routeFrequencies.set(key, (routeFrequencies.get(key) || 0) + 1);
        });

        // Get unique routes with their frequencies
        const uniqueRoutes = new Map();
        flights.forEach(flight => {
            const key = `${flight.from}-${flight.to}`;
            if (!uniqueRoutes.has(key)) {
                uniqueRoutes.set(key, {
                    ...flight,
                    frequency: routeFrequencies.get(key)
                });
            }
        });

        // Find max frequency for color scaling
        const maxFrequency = Math.max(...Array.from(routeFrequencies.values()));

        // Create color blind friendly color scale - blue to orange gradient
        const colorScale = d3.scaleSequential()
            .domain([1, maxFrequency])
            .interpolator(d3.interpolateRgb("#3b82f6", "#ea580c")); // blue to orange

        // Load world map
        Promise.all([
            d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json'),
            d3.json('/assets/data/geo/india_state.json')
        ]).then(([world, indiaData]) => {
            const countries = topojson.feature(world, world.objects.countries);

            // Draw world map
            g.append('g')
                .selectAll('path')
                .data(countries.features)
                .enter().append('path')
                .attr('class', 'country')
                .attr('d', path)
                .style('fill', () => getRandomVintageColor());

            // Overlay India with disputed territories
            const indiaGroup = g.append('g').attr('class', 'india-overlay');

            indiaGroup.selectAll('.india-state')
                .data(indiaData.features)
                .enter().append('path')
                .attr('class', 'india-state')
                .attr('d', path)
                .style('fill', '#d4c48a')
                .style('fill-opacity', 1.0)
                .style('stroke', '#d4c48a')
                .style('stroke-width', 0.5)
                .style('vector-effect', 'non-scaling-stroke');

            // Draw all flight paths with frequency-based colors
            uniqueRoutes.forEach((flight, key) => {
                const fromCoord = airportCoords[flight.from];
                const toCoord = airportCoords[flight.to];

                if (fromCoord && toCoord) {
                    const fromPoint = projection(fromCoord);
                    const toPoint = projection(toCoord);

                    // Create path with gentle curve
                    const midX = (fromPoint[0] + toPoint[0]) / 2;
                    const midY = (fromPoint[1] + toPoint[1]) / 2;

                    const dx = toPoint[0] - fromPoint[0];
                    const dy = toPoint[1] - fromPoint[1];
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    const offsetRatio = 0.1;

                    const controlX = midX - (dy / dist) * dist * offsetRatio;
                    const controlY = midY + (dx / dist) * dist * offsetRatio;

                    // Calculate color based on frequency
                    const pathColor = colorScale(flight.frequency);

                    // Calculate stroke width based on frequency (1.2 to 2.5)
                    const strokeWidth = 1.2 + (flight.frequency / maxFrequency) * 1.3;

                    const pathD = `M ${fromPoint[0]} ${fromPoint[1]} Q ${controlX} ${controlY} ${toPoint[0]} ${toPoint[1]}`;

                    // Create invisible wider path for easier hovering
                    const hitArea = g.append('path')
                        .attr('class', 'flight-path-hitarea')
                        .attr('d', pathD)
                        .attr('data-route', `${cityNames[flight.from]} → ${cityNames[flight.to]}`)
                        .attr('data-frequency', flight.frequency);

                    // Create visible path
                    const flightPath = g.append('path')
                        .attr('class', 'flight-path')
                        .attr('d', pathD)
                        .attr('data-route', `${cityNames[flight.from]} → ${cityNames[flight.to]}`)
                        .attr('data-frequency', flight.frequency)
                        .style('stroke', pathColor)
                        .style('stroke-width', strokeWidth);

                    // Link the two paths for hover effects
                    hitArea.node().__visiblePath = flightPath.node();
                    flightPath.node().__hitArea = hitArea.node();
                }
            });

            // Get all unique airports
            const visitedAirports = new Set();
            flights.forEach(flight => {
                visitedAirports.add(flight.from);
                visitedAirports.add(flight.to);
            });

            // Add airport markers
            visitedAirports.forEach(code => {
                const coords = airportCoords[code];
                const point = projection(coords);

                const circle = g.append('circle')
                    .attr('class', `airport airport-${code}`)
                    .attr('cx', point[0])
                    .attr('cy', point[1])
                    .attr('r', 1.5);

                // Add city name label
                const label = g.append('text')
                    .attr('class', `airport-label label-${code}`)
                    .attr('x', point[0])
                    .attr('y', point[1] - 2.5)
                    .text(cityNames[code]);

                // Add hover functionality
                circle.on('mouseenter', function() {
                    label.classed('hover', true);
                }).on('mouseleave', function() {
                    label.classed('hover', false);
                });

                // Store city name as data attribute
                circle.attr('data-city', cityNames[code]);
            });

            // Add tooltip functionality
            const tooltip = document.getElementById('tooltip');

            // Tooltip for flight paths (using hit areas)
            d3.selectAll('.flight-path-hitarea')
                .on('mouseenter', function(event) {
                    const route = d3.select(this).attr('data-route');
                    const frequency = d3.select(this).attr('data-frequency');
                    const flightText = frequency === '1' ? 'flight' : 'flights';
                    tooltip.textContent = `${route} (${frequency} ${flightText})`;
                    tooltip.classList.add('show');

                    // Highlight the visible path
                    const visiblePath = this.__visiblePath;
                    if (visiblePath) {
                        d3.select(visiblePath).classed('hover', true);
                    }
                })
                .on('mousemove', function(event) {
                    tooltip.style.left = (event.pageX + 10) + 'px';
                    tooltip.style.top = (event.pageY - 30) + 'px';
                })
                .on('mouseleave', function() {
                    tooltip.classList.remove('show');

                    // Remove highlight from the visible path
                    const visiblePath = this.__visiblePath;
                    if (visiblePath) {
                        d3.select(visiblePath).classed('hover', false);
                    }
                });

            // Tooltip for airports
            d3.selectAll('.airport')
                .on('mousemove', function(event) {
                    const city = d3.select(this).attr('data-city');
                    tooltip.textContent = city;
                    tooltip.classList.add('show');
                    tooltip.style.left = (event.pageX + 10) + 'px';
                    tooltip.style.top = (event.pageY - 30) + 'px';
                });

            // Update legend with gradient and max frequency
            const gradientElement = document.getElementById('frequency-gradient');
            gradientElement.style.background = `linear-gradient(to right, ${colorScale(1)}, ${colorScale(maxFrequency)})`;
            document.getElementById('max-flights-label').textContent = `${maxFrequency} flights`;
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            const newWidth = container.clientWidth;
            const newHeight = container.clientHeight;
            svg.attr('viewBox', `0 0 ${newWidth} ${newHeight}`);
        });
    </script>
</body>
</html>
